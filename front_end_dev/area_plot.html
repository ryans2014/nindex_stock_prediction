<!DOCTYPE html>
<meta charset="utf-8">
<style>

.axis {
  font: 15px sans-serif;
}

.axis-title {
  text-anchor: end;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.axis--x path {
}

.axis--y .tick:not(.tick--one) line {
  stroke-opacity: .15;
}

.line {
  fill: none;
  stroke: #000;
  stroke-width: 2.0px;
  stroke-linejoin: round;
  stroke-linecap: round;
}

.area {
}

.area--below {
  fill: red;
}

.area--above {
  fill: green;
}

</style>

<body>
  <svg>

  </svg>
</body>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>

//  DOM main objects
var margin = {top: 30, right: 30, bottom: 40, left: 50},
    width = 960 - margin.left - margin.right,
    height = 600 - margin.top - margin.bottom;

var svg = d3.select("body").select("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)

var svg_g = svg.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// DOM axis objects
var gX = svg_g.append("g")
    .attr("class", "axis axis--x")
    .attr("transform", "translate(0," + height + ")");

var gY = svg_g.append("g")
    .attr("class", "axis axis--y");

gY.append("text")
    .attr("class", "axis-title")
    .attr("transform", "rotate(-90)")
    .attr("y", 6)
    .attr("dy", ".71em")
    .text("Price");

// d3 objects
// var parseDate = d3.timeParse("%y-%b-%d");
var parseDate = d3.timeParse("%Y-%m-%d");
var x = d3.scaleTime().range([0, width]);
var y = d3.scaleLinear().range([height, 0]);

var xAxis = d3.axisBottom(x);
var yAxis = d3.axisLeft(y)

var zoom = d3.zoom()
    .scaleExtent([1, 32])
    .translateExtent([[0, 0], [width, height]])
    .extent([[0, 0], [width, height]])
    .on("zoom", zoomed);

var line = d3.line()
    .x(function(d) { return x(d.date); })
    .y(function(d) { return y(d.y1); });

var area_above = d3.area()
    .x(function(d) { return x(d.date); })
    .y0(function(d) { return y(d.y1); })
    .y1(function(d) { return y(d.y2); });

var area_below = d3.area()
    .x(function(d) { return x(d.date); })
    .y0(function(d) { return y(d.y0); })
    .y1(function(d) { return y(d.y1); });

// read data and make plots
d3.csv("data.csv")
    .row(function(d) { return {date: d.date, close: +d.close, predict: +d.predict}; })
    .get(function(error, rows) {
        if (error) throw error;

        // process data
        rows.forEach(function(row) {
            row.date = parseDate(row.date);
        });
        rows.forEach(function(row) {
            row.y1 = row.close;
            row.y0 = d3.min([row.close, row.close + row.predict]);
            row.y2 = d3.max([row.close, row.close + row.predict]);
        });

        // set input domain
        x.domain(d3.extent(rows, function(row) { return row.date; }));
        y.domain(d3.extent(rows, function(row) { return row.y1; }));

        // set axis
        yAxis.tickValues(d3.scaleLinear().domain(y.domain()).ticks(20));
        gX.call(xAxis);
        gY.call(yAxis)
            .selectAll(".tick")
            .classed("tick--one", function(d) { return Math.abs(d - 1) < 1e-6; });

        // generate line plot and area plot
        var defs = svg_g.append("defs");

        svg_g.append("path")
            .datum(rows)
            .attr("class", "area area--above")
            .attr("d", area_above);

        svg_g.append("path")
            .datum(rows)
            .attr("class", "area area--below")
            .attr("d", area_below);

        svg_g.append("path")
            .datum(rows)
            .attr("class", "line")
            .attr("d", line);

        // register zooming
        // d3.select("svg").call(zoom);
        var d0 = rows[rows.length - d3.min([356, rows.length])].date,
            d1 = rows[rows.length - 1].date;

        // Gratuitous intro zoom
        svg.call(zoom).transition()
            .duration(1500)
            .call(zoom.transform, d3.zoomIdentity
            .scale(width / (x(d1) - x(d0)))
            .translate(-x(d0), 0));
    });

function zoomed() {
    var t = d3.event.transform, xt = t.rescaleX(x), yt = t.rescaleY(y);
    d3.select(".area--above").attr("d", area_above.x(function(d) { return xt(d.date); }))
                             // .attr("d", area_above.y0(function(d) { return yt(d.y1); }))
                             // .attr("d", area_above.y1(function(d) { return yt(d.y2); }));
    d3.select(".area--below").attr("d", area_below.x(function(d) { return xt(d.date); }))
                             // .attr("d", area_below.y0(function(d) { return yt(d.y0); }))
                             // .attr("d", area_below.y1(function(d) { return yt(d.y1); }));
    d3.select(".line").attr("d", line.x(function(d) { return xt(d.date); }))
                      // .attr("d", line.y(function(d) { return yt(d.y1); }));
    gX.call(xAxis.scale(xt));
    // gY.call(yAxis.scale(yt));
}

</script>
